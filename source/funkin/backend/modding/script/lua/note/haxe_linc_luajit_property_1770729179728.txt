OKã§ã™ ğŸ‘
ã§ã¯ã€Haxe ã®ã‚¯ãƒ©ã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ Lua ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
linc_luajit + ãƒ¡ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

ç›®çš„

Haxe å´ã« Person ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹
Lua å´ã‹ã‚‰ person.name ã‚„ person.age ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
Lua å´ã§å€¤ã‚’å¤‰æ›´ã™ã‚‹ã¨ Haxe å´ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚‚åæ˜ ã•ã‚Œã‚‹


å®Œå…¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
Haxeimport cpp.Lib;
import linc.luajit.Lua;

class Person {
    public var name:String;
    public var age:Int;

    public function new(name:String, age:Int) {
        this.name = name;
        this.age = age;
    }
}

class Main {
    static function main() {
        var L = Lua.luaL_newstate();
        Lua.luaL_openlibs(L);

        // Personã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        var person = new Person("Taro", 20);

        // Haxeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Luaã«æ¸¡ã™
        pushPerson(L, person);
        Lua.lua_setglobal(L, "person");

        // Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        var script = "
            print('Luaã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹: name =', person.name, ', age =', person.age)
            person.name = 'Jiro'
            person.age = 25
            print('å¤‰æ›´å¾Œ: name =', person.name, ', age =', person.age)
        ";
        if (Lua.luaL_dostring(L, script) != 0) {
            trace('Luaã‚¨ãƒ©ãƒ¼: ' + Lua.lua_tostring(L, -1));
        }

        // Haxeå´ã§å¤‰æ›´ã‚’ç¢ºèª
        trace('Haxeå´: name = ' + person.name + ', age = ' + person.age);

        Lua.lua_close(L);
    }

    // Personã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Luaã«pushã™ã‚‹é–¢æ•°
    static function pushPerson(L:Dynamic, p:Person) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦Haxeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿æŒ
        var ud = Lua.lua_newuserdata(L, cpp.Native.sizeof(p));
        cpp.Native.memcpy(ud, cpp.Pointer.addressOf(p), cpp.Native.sizeof(p));

        // ãƒ¡ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
        Lua.lua_newtable(L);

        // __index ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å–å¾—ï¼‰
        Lua.lua_pushcfunction(L, function(L) {
            var obj:Person = cpp.Pointer.fromRaw(Lua.lua_touserdata(L, 1)).ref;
            var key = Lua.lua_tostring(L, 2);
            switch (key) {
                case "name": Lua.lua_pushstring(L, obj.name);
                case "age": Lua.lua_pushinteger(L, obj.age);
                default: Lua.lua_pushnil(L);
            }
            return 1;
        });
        Lua.lua_setfield(L, -2, "__index");

        // __newindex ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šï¼‰
        Lua.lua_pushcfunction(L, function(L) {
            var obj:Person = cpp.Pointer.fromRaw(Lua.lua_touserdata(L, 1)).ref;
            var key = Lua.lua_tostring(L, 2);
            switch (key) {
                case "name": obj.name = Lua.lua_tostring(L, 3);
                case "age": obj.age = Lua.lua_tointeger(L, 3);
            }
            return 0;
        });
        Lua.lua_setfield(L, -2, "__newindex");

        // ãƒ¡ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«è¨­å®š
        Lua.lua_setmetatable(L, -2);
    }
}


å®Ÿè¡Œçµæœä¾‹
Luaã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹: name =	Taro	, age =	20
å¤‰æ›´å¾Œ: name =	Jiro	, age =	25
Haxeå´: name = Jiro, age = 25


è§£èª¬

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ (lua_newuserdata)

Lua å´ã« Haxe ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒã‚¤ãƒ³ã‚¿ã‚’æ¸¡ã™


ãƒ¡ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« (__index / __newindex)

__index â†’ Lua ã‹ã‚‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å–å¾—æ™‚ã«å‘¼ã°ã‚Œã‚‹
__newindex â†’ Lua ã‹ã‚‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šæ™‚ã«å‘¼ã°ã‚Œã‚‹


åŒæ–¹å‘ã‚¢ã‚¯ã‚»ã‚¹

Lua å´ã§å¤‰æ›´ã—ãŸå€¤ãŒ Haxe å´ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åæ˜ ã•ã‚Œã‚‹




ğŸ’¡ ã“ã®ä»•çµ„ã¿ã‚’ä½¿ãˆã°ã€Lua ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ Haxe ã®ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„è¨­å®šå€¤ã‚’ç›´æ¥æ“ä½œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ä¾‹ãˆã°ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³å†…ã§ player.hp ã‚„ enemy.speed ã‚’ Lua ã‹ã‚‰å¤‰æ›´å¯èƒ½ã«ã§ãã¾ã™ã€‚

ã‚‚ã—å¸Œæœ›ãŒã‚ã‚Œã°ã€ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ ã€Œè¤‡æ•°ã®Haxeã‚¯ãƒ©ã‚¹ã‚’Luaã«ç™»éŒ²ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã€ å½¢ã«æ‹¡å¼µã§ãã¾ã™ã€‚
ã“ã‚Œã‚’ä½œã‚Œã°ã€Lua å´ã§ newPlayer() ã¿ãŸã„ã«ç”Ÿæˆã‚‚å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
ã“ã‚Œã€ä½œã‚Šã¾ã™ã‹ï¼Ÿ
